# Rust改写3FS中的FUSE模块 结题报告
## 0. Valor-go团队成员
吕祖灿  杨奕麟  任壮壮  梁修宁  王淇辉

## 1. 项目简介
文件系统是数据存储的核心基础，现有 3FS 系统在性能、安全性和可维护性上面临挑战，尤其是其 FUSE 模块在处理高并发请求时效率不足，且传统实现方式存在内存安全隐患。本项目旨在​​利用 Rust 语言的内存安全特性和零成本抽象能力，对 3FS 文件系统进行系统性重构，并重点升级其 FUSE 模块​​。我们将设计并实现融合高效 I/O、零拷贝传输等技术的现代化 FUSE 架构，显著降低上下文切换开销，提升系统吞吐量和响应速度。同时，Rust 的强类型和所有权机制将从源码层面保障系统稳定性与安全性。本项目预期通过实验性构建一个优化版本的 3FS，旨在 ​​尝试​​提升关键基础设施中 FUSE 模块的性能与可靠性，​​同时探索​​系统软件如何通过安全现代技术（如 Rust）进行改造的 ​​可行路径​​，以期对基础软件生态的发展 ​​提供有价值的实践参考​​。

## 2. 项目背景与意义
### 2.1 3FS文件系统

#### 3FS概述

随着当下大模型以及其在各个领域的应用愈加火热，有关于如何提升大模型表现的探索也在快速发展。在日常训练的过程中，训练速度与推理速度是两大重要指标。训练速度牵涉到模型与数据的统合训练与多次的加载与迭代。推理速度则牵涉到推理流程以及相关状态的缓存与读取。当前，硬件设备带来的计算速度提高，包括云计算等多种新兴计算技术带来的计算资源统合，无疑促进了AI的井喷式发展，此时，若能够在AI训练的底层基石——数据进行结构性优化，即设计更加专一为AI训练场景服务的文件系统，那么对于大模型的表现将会又上一个台阶。对此，DeepSeek推出了自己的解答，3FS。

3FS，即Fire-Flyer File System，是DeepSeek开源的高性能分布式文件系统，专为AI训练和推理任务设计。这里的专为AI训练推理体现在3FS作为文件系统对于AI训练数据加载的极强表现和对于AI训练场景所需的任务优化。

#### 3FS技术特点

- 使用典型分布式架构，3FS通过搭建在大量SSD RDMA网络之上，并结合Direct I/O 技术，实现无缓存加载数据；
- 使用CRAQ技术，保证数据的强一致性，作为分布式架构稳固的正确性保证；
- 同时3FS本身的系统设计可以支持随机异步I/O，以此可以针对AI推理的负载进行优化。

|       |          推理的需求           |               3FS的特点               |
| :---: | :----------------------: | :--------------------------------: |
|  吞吐量  |         极高的I/O速度         |              并行分布式架构               |
|  随机性  |       随机读取文件（随机取样）       |        实现无缓存Direct I/O，支持随机        |
| 数据准确性 |         读写的正确一致性         | 使用链式复制CRAQ，强一致性保证分布式结构下训练数据高准确性的要求 |
| 推理速度  | [AI](http://4.ai/)负载工作优化 |    KVCache——大模型推理，并发随机I/O——数据加载    |
| 延伸与应用 |        接口使用易用与高效         |    FUSE & USRBIO 共同使用，双端保证易用与高效    |

#### 3FS搭载表现
完整性能表现报告参考[3FS Github页面](https://github.com/deepseek-ai/3FS "README.md")

![3FS performance](../investigation_report/pics/3FS_performance.jpg)
> 上图展示了大型 3FS 集群上读取压力测试的吞吐量。该集群由 180 个存储节点组成，每个节点配备 2×200Gbps InfiniBand 网卡和 16 个 14TiB NVMe SSD。大约使用了 500+ 个客户端节点进行读取压力测试，每个客户端节点配置了 1 个 200Gbps InfiniBand 网卡。最终的聚合读取吞吐量达到大约 6.6 TiB/s。


从中不难看出，3FS带来了强大的性能表现，6TiB级别的每秒吞吐量级可以大大提升大模型训练的速度。
### 2.2 Rust

#### 2.2.1 Rust概述

> Rust 是一门系统编程语言，专注于安全 ，尤其是并发安全，支持函数式和命令式以及泛型等编程范式的多范式语言。

Rust是一门为了解决并发和安全性（也包括并法中的安全性）系统问题的编程语言。相比于传统的C，C++等语言，Rust通过其本身的独特设计，尤其强调安全，内存控制和并发处理。

当下，C语言由于其简洁性尽管仍然受到大量轻度开发者的青睐，可在大型项目中，受制于C语言需要手动管理内存，容易造成内存泄漏等安全问题，Rust便可以在这方面保证极高的安全性。

#### 2.2.2 Rust & 3FS 的可能

根据Rust语言的特性：并发处理，安全保证

- 3FS基于分布式架构，使用异步I/O，Rust可以更好保证并发请求的处理
- 3FS大量源码使用C，C++编写，使用Rust改写可以增强其安全性，可用性

### 2.3 项目意义
#### 2.3.1 Rust改写FUSE的实际价值
+ Rust改写FUSE的主要优势：内存安全、性能优化、跨平台支持
+ FUSE：C语言编写，缺乏内存安全机制，容易导致野指针、空指针、缓冲区溢出等内存错误，这些错误可能导致文件系统崩溃或数据损坏。
  + Rust的优势：Rust通过其独特的借用检查器和所有权系统，确保在编译时消除内存安全问题。这使得使用Rust改写FUSE可以从根本上减少内存错误的风险，提高文件系统的稳定性和可靠性。
+ FUSE：作为用户空间文件系统实现，需要通过系统调用与内核进行通信，造成额外的开销。此外，C语言的静态类型和指针操作不够高效。
  + Rust的优势：Rust的零成本抽象和现代编译器优化使得其生成的机器码与C语言相当，甚至在某些情况下更高效。Rust的并发模型和轻量级线程（threads）可以更高效地处理I/O操作，减少系统调用的开销，从而提高文件系统的整体性能
+ FUSE：主要针对Linux系统，在其他系统上使用体验并不佳。
  + Rust的优势：Rust提供了一个统一的依赖管理工具（Cargo）和包管理仓库（Crates.io）。通过Cargo，开发者可以轻松管理项目依赖，并将代码编译到多种平台（如Windows、macOS、FreeBSD等），使得改写后的FUSE可以在多种操作系统上运行，提高了文件系统的跨平台支持能力。Rust的Cargo build –all-targets命令可以一次性为所有支持的平台（如Windows、macOS、Linux等）编译代码，而无需手动调整编译选项或配置文件。
#### 2.3.2 项目对于我们的意义
+ 一次学习rust语言并应用的机会:Rust作为一门新兴的系统级别的编程语言，它旨在解决C/C++等语言在系统级编程中常见的安全性和并发性等问题。
+ 大型项目的源码学习经历：学习大型项目的结构组织，代码规范性
+ 前沿项目的学习： 3FS（Fire-Flyer 文件系统）是当下最先进高效的大模型文件系统之一。选择改写3FS体系下的FUSE模块，需要阅读3FS的大部分源码，可以深入了解当前领先的大模型文件系统的底层逻辑和具体实现原理。
+ 操作系统的学习：在项目进展中会涉及学习操作系统的内核结构、调度机制、中断处理、安全模型、用户与组管理、文件权限和加密机制等

### 3. 研究目标与内容
#### 3.1 原计划研究目标

#### 3.2 实际项目内容
