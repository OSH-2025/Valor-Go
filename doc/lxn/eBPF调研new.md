# eBPF技术调查报告
**PB23050916 梁修宁 OSH-team2**

## 一、eBPF技术基本信息
eBPF（extended Berkeley Packet Filter）是一种强大的内核技术，允许开发者编写高效、低开销的程序，来执行一些复杂的底层操作，而无需修改操作系统内核的源码或重启系统，通常用于监控、调试、安全、性能分析等场景。

### eBPF作为编程方式的特点：
**内核级编程：**
eBPF 代码运行在操作系统内核层面，而不是用户空间。这意味着它可以直接操作和访问内核数据结构和事件，非常适合进行底层操作、性能监控、安全检查等任务。

**无需修改内核源码：**
使用 eBPF 编写的程序可以动态加载到内核中执行，而不需要修改操作系统的源代码或重新编译内核。这使得 eBPF 在开发和部署时非常灵活，能够在不改变操作系统本身的情况下扩展功能。


**运行时动态加载：**
一旦编写了 eBPF 程序，它们可以在运行时被动态加载到内核中，这使得 eBPF 程序非常适用于实时监控和调试任务，而无需修改内核源码或重启系统。

**强大的扩展性和灵活性：**
eBPF 提供了一个强大的框架，通过“钩子”在操作系统内核的不同部分插入自定义代码。开发者可以使用 eBPF 扩展内核功能，增强网络安全、性能监控、异常检测等功能。

## 二、当前eBPF技术的应用方向
**1.网络监控与包过滤：**
最初，eBPF 是 Berkeley Packet Filter（BPF）的扩展，主要用于高效的网络包过滤。它允许在内核中执行轻量级的程序来捕获、过滤和处理数据包。

**2.性能分析与监控：**
eBPF 可以用来监控内核和应用程序的性能。通过追踪系统调用、函数调用、内存分配等，可以帮助开发人员分析和优化性能。

**3.安全性：**
eBPF 为 Linux 内核提供了一个安全的扩展机制，可以帮助检测和防止一些恶意活动。例如，它被用于实现一些安全工具，如 Cilium、Falco 等，提供系统级别的安全监控。

**4.追踪与调试：**
eBPF 可以用于动态追踪和调试应用程序的行为。通过对系统的实时数据进行采集，eBPF 使得开发人员能够在不重新启动系统或应用程序的情况下进行分析和调试。

**5.无缝与内核集成：**
eBPF 程序可以直接加载到内核的不同子系统中，而不需要修改内核代码。这使得 eBPF 可以在生产环境中动态运行，而不会影响系统的稳定性。

## 三、eBPF 的工作机制
一般 eBPF 的工作逻辑是：

1.通常使用 C语言编写BPF Program，通过 LLVM/Clang 编译成 eBPF 定义的字节码 prog.bpf。

2.系统调用 bpf() 将 bpf 字节码指令传入内核中。

3.经过 verifier 检验字节码的安全性、合规性。

4.在确认字节码安全后将其加载对应的内核模块执行，通过 Helper/hook 机制，eBPF 与内核可以交换数据/逻辑。BPF 观测技术相关的程序程序类型可能是 kprobes/uprobes/tracepoint/perf_events 中的一个或多个，其中：
kprobes：实现内核中动态跟踪。kprobes 可以跟踪到 Linux 内核中的函数入口或返回点，但是不是稳定 ABI 接口，可能会因为内核版本变化导致，导致跟踪失效。理论上可以跟踪到所有导出的符号 /proc/kallsyms。

uprobes：用户级别的动态跟踪。与 kprobes 类似，只是跟踪的函数为用户程序中的函数。

tracepoints：内核中静态跟踪。tracepoints 是内核开发人员维护的跟踪点，能够提供稳定的 ABI 接口，但是由于是研发人员维护，数量和场景可能受限。

perf_events：定时采样和 PMC。

5.用户空间通过 BPF map 与内核通信。

## 四、常见的 eBPF 工具与框架

**1.BCC (BPF Compiler Collection)：**一个用于开发和调试 eBPF 程序的工具集，提供了易于使用的 Python API，支持监控、追踪等功能。

**2.bpftrace：**类似于 DTrace 的工具，用于编写简单的脚本来对内核进行动态追踪。

**3.Cilium：**一个基于 eBPF 的开源网络安全项目，用于实现高效的网络策略和负载均衡。

**4.XDP (eXpress Data Path)：**一个 eBPF 应用框架，用于处理高速网络流量，支持数据包过滤、负载均衡等高性能网络操作。

## 五、选题方向——已有设计的优化
**1. 网络流量监控与分析工具**

目标：开发一个基于 eBPF 的网络流量监控工具，实时捕获并分析网络数据包。

项目说明：使用 eBPF 监听网络接口的流量，提取出有用的网络信息，如来源 IP 地址、数据包大小、协议类型等，分析流量模式。工具可以显示哪些进程占用了最多的网络带宽，或者检测异常流量。

挑战：
需要了解网络协议栈，如何解析数据包头部。
如何高效地使用 eBPF 进行数据包过滤和统计。

**2. 系统调用追踪与分析**

目标：开发一个系统调用分析工具，捕获特定进程或所有进程的系统调用，并进行统计分析。

项目说明：使用 eBPF 跟踪系统调用，查看每个进程调用的系统调用类型、频率、参数等信息。这对了解程序的行为以及进行性能分析很有帮助。你们可以在此基础上做一些拓展，如检测某些特定系统调用的滥用。

挑战：
需要理解系统调用的工作原理。
需要处理数据的收集和高效统计。

**3. 内存访问监控与分析**

目标：创建一个基于 eBPF 的内存访问监控工具，分析进程的内存使用模式，找出潜在的内存泄漏或性能瓶颈。

项目说明：eBPF 可以用来监控进程的内存访问，例如每次内存分配和释放时记录相关信息。你们可以分析是否存在内存泄漏、频繁的内存分配和释放等问题。

挑战：
需要理解内存管理的基本概念。
需要高效地处理大量的内存访问数据。

**4. 进程行为审计与安全监控**

目标：开发一个进程行为监控工具，跟踪进程的文件访问、网络活动等行为，检测潜在的安全问题。

项目说明：eBPF 可以用来捕获进程的行为，特别是系统调用、文件访问、网络操作等。此工具可用于监控潜在的恶意活动，检测某些特定进程的异常行为或不当操作。

挑战：
需要处理大量的进程数据并及时反馈。
需要设计算法来识别异常行为。



**5. 实时系统性能监控与调优工具**

目标：创建一个系统性能监控工具，实时跟踪 CPU 使用率、内存使用情况、I/O 等性能指标，帮助分析系统瓶颈。

项目说明：利用 eBPF 跟踪系统的性能指标，包括 CPU 使用率、内存分配、磁盘 I/O、网络流量等。这将帮助开发者定位系统瓶颈，进行性能优化。

挑战：
需要高效地收集和展示系统性能数据。
需要理解操作系统的资源管理与调度策略。


## 六、参考网站
华为云社区：《深入解读 eBPF：零侵扰性能追踪与 Java I/O 优化》https://bbs.huaweicloud.com/blogs/435938

CSDN:《初识 eBPF（功能、原理、及一些应用）》https://blog.csdn.net/qq_24433609/article/details/125879684

微信公众号：《eBPF 基本架构及使用》https://mp.weixin.qq.com/s/K-E3_MC9Hp3ppGBznaCUEQ

腾讯云社区：《基于 eBPF 的容器监控工具 Eunomia （目标描述、ebpf 监控调研）》 https://cloud.tencent.com/developer/article/2225073

https://selfboot.cn/2023/11/08/memory_leak_ebpf/